{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/ibridge/","result":{"data":{"site":{"siteMetadata":{"title":"NoSleep Javascript Blog"}},"markdownRemark":{"id":"2d254187-2f44-5f6f-a5bf-253d83d70bd1","excerpt":"TLDR I forked postmate and called it . It uses Typescript and has cool features regarding type safety. I improved the semantics of . I made the code simpler. I…","html":"<h2 id=\"tldr\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLDR</h2>\n<ul>\n<li>I forked <a href=\"https://github.com/dollarshaveclub/postmate\">postmate</a> and called it <code class=\"language-text\">ibridge</code>.</li>\n<li>It uses <a href=\"https://www.typescriptlang.org/\">Typescript</a> and has cool features regarding type safety.</li>\n<li>I improved the semantics of <code class=\"language-text\">iparent.get</code>.</li>\n<li>I made the code simpler.</li>\n<li>I made both <code class=\"language-text\">ibridge.Parent</code> and <code class=\"language-text\">ibridge.Child</code> be Event Emitters for better composition.</li>\n<li>It has worked super fine!</li>\n</ul>\n<div style=\"text-align: center; margin-top: 60px;\">\n  <img src=\"https://raw.githubusercontent.com/twitter/twemoji/master/assets/svg/1f309.svg\" width=\"200\" alt=\"ibridge logo\">\n  <h3 style=\"text-align: center;\">ibridge</h3>\n  <p style=\"text-align: center; margin-top: -15px;\">\n    <small>logo by <a href=\"https://twemoji.twitter.com\">twemoji</a></small>\n  </p>\n</div>\n<h2 id=\"introduction\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>I have recently published <a href=\"https://www.npmjs.com/package/ibridge\">ibridge</a>, a tiny, typesafe, promise-based library\nfor bidirectional and secure <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe\">iframe</a> communication.</p>\n<ul>\n<li><a href=\"https://www.npmjs.com/package/ibridge\">npm</a></li>\n<li><a href=\"https://github.com/franleplant/ibridge\">repo</a></li>\n</ul>\n<h2 id=\"what-is-ibridge\"><a href=\"#what-is-ibridge\" aria-label=\"what is ibridge permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is ibridge</h2>\n<p>ibridge let’s you</p>\n<ul>\n<li>Retrieve data from the child to the parent.</li>\n<li>Implement complex communication flows between parent and child iframes.</li>\n<li>Pre establish a communication flow via a simple <strong>handshake</strong> <em>protocol</em>.</li>\n</ul>\n<h2 id=\"how-it-works\"><a href=\"#how-it-works\" aria-label=\"how it works permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How it works</h2>\n<p><img src=\"/f146223321c4c8bcd11065864ede9b00/ibridge.svg\" alt=\"ibridge high level flow diagram\"></p>\n<ul>\n<li>ibridge is an abstraction on top of <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\">postMessage</a>.</li>\n<li>Exposes <code class=\"language-text\">ibridge.Parent</code> and <code class=\"language-text\">ibridge.Child</code>, used by the parent and child document respectively.</li>\n<li>In here we call their instances <code class=\"language-text\">iparent</code> and <code class=\"language-text\">ichild</code> respectively.</li>\n<li>Both <code class=\"language-text\">Parent</code> and <code class=\"language-text\">Child</code> are <strong>event emitters</strong> implemented via <a href=\"https://www.npmjs.com/package/emittery\">Emittery</a>.</li>\n<li>Security is handled entirely by native <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors\">CSP headers</a>.</li>\n<li>At the initial phase it performs a <strong>handshake</strong> in which the Parent sends a special message to the child and waits for a special response.</li>\n</ul>\n<h3 id=\"remote-function-calls-from-parent-to-child-the-most-common-flow\"><a href=\"#remote-function-calls-from-parent-to-child-the-most-common-flow\" aria-label=\"remote function calls from parent to child the most common flow permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remote function calls from Parent to Child (the most common flow)</h3>\n<p>The Child is able to define a <code class=\"language-text\">Model</code> which is made off all the functions that\n<strong>live in the Child</strong> that can be called remotely by the Parent.</p>\n<p><code class=\"language-text\">Model</code> can be a trivially deeply nested object, and each Model function\ncan by sync or async, returning a resolved or rejected <code class=\"language-text\">Promise</code> that will be\nautomatically sent back to the Parent without any surprises. Return\nvalues and arguments can be anything that can serializable, plus, return\nvalues can be any <code class=\"language-text\">Promise</code> to a serializable value. Let’s see an example:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> resolvedValue <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> iparent<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"blog.analytics.getPageViews\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"page1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"page2\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>rejectedValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle errors</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Internally this means an event flow like the following:</p>\n<p><strong>1)</strong> parent to child</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">sendToChild</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\n  modelPath<span class=\"token operator\">:</span> <span class=\"token string\">\"blog.analytics.getPageViews\"</span><span class=\"token punctuation\">,</span>\n  arguments<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"page1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"page2\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>2)</strong> child to parent</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> model<span class=\"token punctuation\">.</span>blog<span class=\"token punctuation\">.</span>analytics<span class=\"token punctuation\">.</span><span class=\"token function\">getPageViews</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"page1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"page2\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">sendToParent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET-RESOLVE\"</span><span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">sendToParent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET-REJECT\"</span><span class=\"token punctuation\">,</span>\n    error<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This makes for a pretty standard and easy to understand model,\nthis thing that seems so intuitive was one of the main reasons\nI departed from the original implementation in <a href=\"https://github.com/dollarshaveclub/postmate\">postmate</a>, more on this later.</p>\n<p>If it feels natural or even dumb then I have succeeded.</p>\n<h3 id=\"free-form-communication\"><a href=\"#free-form-communication\" aria-label=\"free form communication permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Free form communication</h3>\n<p>ibrigde also lets you build more complex bidirectional flows via high level events</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Send events to the child</span>\niparent<span class=\"token punctuation\">.</span><span class=\"token function\">emitToChild</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ping\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"i am father\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// listen to events from the child</span>\niparent<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pong\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// listen to events from the parent</span>\nichild<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ping\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// send message to the parent</span>\n  ichild<span class=\"token punctuation\">.</span><span class=\"token function\">emitToParent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pong\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">\"i am child\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Internally ibridge has a single event listener for <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\">postMessage</a> (the Dispatcher) in both\nthe Parent and the Child that will listen to valid ibridge messages\nand dispatch them as <a href=\"https://www.npmjs.com/package/emittery\">Emittery</a> events. This allows you to use higher level\nevent emitters abstractions such as <code class=\"language-text\">once</code>, <code class=\"language-text\">off</code>, <code class=\"language-text\">onAny</code>, etc.</p>\n<p>Fun fact, ibridge uses also <code class=\"language-text\">Emittery</code> for the handshake mechanism.</p>\n<h2 id=\"why-ibridge-was-created\"><a href=\"#why-ibridge-was-created\" aria-label=\"why ibridge was created permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why ibridge was created</h2>\n<p>I have been designing and implementing an <code class=\"language-text\">sdk</code> to provide\nconsumers (other companies and services) to use our platform\n(let’s call it <strong>Platform A</strong>) from outside our own controlled domains.</p>\n<p>For different circumstances and limitations I can’t really state publicly\nwe ended up choosing an iframe based solution so that consumers (parent document)\ncould interact through high level abstract APIs with our platform (child document).</p>\n<p>This is similar to what other providers already do like Patreon (see link at the bottom),\nTwitter embedded tweets (see tweet below), etc.\nThis bypasses certain cross domain limitations by using an embedded document.</p>\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">React is slow, what now? <a href=\"https://t.co/y8cfBxFrEY\">https://t.co/y8cfBxFrEY</a></p>&mdash; franleplant (@franleplant) <a href=\"https://twitter.com/franleplant/status/1334960068392005638?ref_src=twsrc%5Etfw\">December 4, 2020</a></blockquote>\n<blockquote>\n<p><strong>DANGER ALERT</strong> iframes are a delicate topic since there are a lot of security\nconcerns present. Make sure you allow your page to be rendered inside an iframe\nby controlling the <code class=\"language-text\">Content-Security-Policy</code> HTTP header. Read <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors\">more in MDN</a>,\nand be sure to understand how the browser security model works related to iframes fully\nbefore launching to production.</p>\n</blockquote>\n<p>Since most of the work in building such <code class=\"language-text\">sdk</code> lies on building a good\nhigher level communication protocol between <code class=\"language-text\">parent</code> and <code class=\"language-text\">child</code> we started\nby using an already existing solution called <a href=\"https://github.com/dollarshaveclub/postmate\">postmate</a>, and it worked\nwell until it didn’t anymore. We tried hacking around it\nbut in the end the implementation was far too noisy because of some\ncore problems in <code class=\"language-text\">postmate</code>, that’s why I decided to fork it.</p>\n<h2 id=\"why-postmate-was-not-enough\"><a href=\"#why-postmate-was-not-enough\" aria-label=\"why postmate was not enough permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why Postmate was not enough</h2>\n<p>I created <a href=\"https://github.com/dollarshaveclub/postmate/issues/211\">an issue</a> in Postmate’s repo to see if we can unify efforts eventually.</p>\n<p>These are the problems I found with Postmate that made me fork it:</p>\n<h3 id=\"wrong-semantics-for-code-classlanguage-textiparentgetcode\"><a href=\"#wrong-semantics-for-code-classlanguage-textiparentgetcode\" aria-label=\"wrong semantics for code classlanguage textiparentgetcode permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrong semantics for <code class=\"language-text\">iparent.get</code></h3>\n<p>Postmate doesn’t have good semantics for <code class=\"language-text\">.get</code>, in fact, if you call a child model\nthrough Postmate’s <code class=\"language-text\">.get</code> and that model throws then you won’t receive a failing promise in the\nparent, in fact that’s one of the main things we had to hack around internally and other’s have opened\n<a href=\"https://github.com/dollarshaveclub/postmate/issues/94\">issues and hacked around too</a>.</p>\n<p>One of our main use cases, and when you think about it, it’s probably the main use case for a lot of\nusers; was and is to remotely call functions that live in the child and get the resolved or rejected values\nwith that same semantics in the Parent so we can report back to the parent’s consumer.</p>\n<blockquote>\n<p><strong>ibridge</strong> gives better semantics to <code class=\"language-text\">.get</code> by making it a deconstructed remote function call that handles\nreturn values and errors thrown in ways that feel natural, hiding the underlying mechanisms completely.</p>\n</blockquote>\n<h3 id=\"wrong-semantics-and-name-for-code-classlanguage-textiparentcallcode\"><a href=\"#wrong-semantics-and-name-for-code-classlanguage-textiparentcallcode\" aria-label=\"wrong semantics and name for code classlanguage textiparentcallcode permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrong semantics and name for <code class=\"language-text\">iparent.call</code></h3>\n<p>On first read one might think that <code class=\"language-text\">iparent.call</code> is the main way of remote calling model functions\nin the child from the parent but is actually not, it just a way of <strong>calling model functions\njust for the side effects</strong>.</p>\n<p>This makes no sense, we already can cover that with <code class=\"language-text\">.get</code>, if the consumer doesn’t care\nabout the model’s return function then it simply can be omitted. This is exactly how\nwe handle function calls in regular programs. If we do not care about their return value\nwe just call them for their side effects with the same mechanism we call them when we do care\nabout their return values <em>or errors</em>.</p>\n<p>Another use case for <code class=\"language-text\">.call</code> can be simply <strong>emitting events</strong> to the child, but it doesn’t have\na good name to reflect that and being strictly related to child model functions not always\nfits the flow users have in mind.</p>\n<blockquote>\n<p><strong>ibridge</strong> doesn’t have <code class=\"language-text\">.call</code> and instead you simply can <code class=\"language-text\">iparent.emitToParent</code> and we also provide\nthe opposite: <code class=\"language-text\">ichild.emitToChild</code> and everything is abstracted by relying on <code class=\"language-text\">Emittery</code> as much as possible.</p>\n</blockquote>\n<h3 id=\"the-model-implementation-is-just-too-simplistic\"><a href=\"#the-model-implementation-is-just-too-simplistic\" aria-label=\"the model implementation is just too simplistic permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Model implementation is just too simplistic</h3>\n<p>We very early found ourselves hoping to be able to call deeply nested Model functions\nbut found that postmate only accepted model keys, this means that\nyou need to collapse all your model functions into a single shallow object.</p>\n<p>This is too simplistic and prevents users from building more complex\nmodel structures.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">iparent<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"blogPostsGetPageViews\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// child model</span>\n<span class=\"token keyword\">const</span> model <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">blogPostsGetPageViews</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/*...*/</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p><strong>ibridge</strong> allows <code class=\"language-text\">.get</code> to accept a lodash’s <code class=\"language-text\">path</code> to the model, by relying on <a href=\"https://lodash.com/docs/4.17.15#get\">lodash.get</a>.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">iparent<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"blog.posts.getPageViews\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// child model</span>\n<span class=\"token keyword\">const</span> model <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  blog<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    posts<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">getPageViews</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/*...*/</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"model-context\"><a href=\"#model-context\" aria-label=\"model context permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Model context</h3>\n<p>Another thing we find ourselves wanting was the capability of providing a simple\nModel context that could be accessible to all model functions should they need to.</p>\n<p>With Postmate you need to roll out your own implementation, but there’s a really easy\nway of providing a simple context implementation without letting the user roll\nout their own implementation.</p>\n<blockquote>\n<p><code class=\"language-text\">ibridge</code> provides an easy way of passing <code class=\"language-text\">context</code> to all Model functions.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">myModel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> IContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// accessible via this</span>\n  <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"debugging\"><a href=\"#debugging\" aria-label=\"debugging permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Debugging</h3>\n<p>Postmate used a simplistic approach based on an <code class=\"language-text\">env</code> variable and a bunch of <code class=\"language-text\">if</code> statements.\nThis wasn’t ideal since it didn’t work always as expected, required bundler configuration, and the handling was way to manual.</p>\n<blockquote>\n<p><code class=\"language-text\">ibridge</code> uses <a href=\"https://www.npmjs.com/package/debug\">debug</a> for a more structured way of configuring and outputting debug / logs.\nCheck the docs for more information.</p>\n</blockquote>\n<p>Example of enabling verbose output.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// you might need to do this in the child document too</span>\n<span class=\"token comment\">// check the `storage` dev tools tab.</span>\n\nlocalStorage<span class=\"token punctuation\">.</span>debug <span class=\"token operator\">=</span> <span class=\"token string\">\"ibridge:*\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This will output a <em>lot</em> of information that should make it really easy to debug the workings\nof any consumer of the lib and the lib it self.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAAChUlEQVQ4y32UZ3LbQBSDdZLYYdleWJakClVt3/9ICHapZDIZRz+eqJHETwAelrsmalTngGaKMP0Vpluh+jOaLqGyElVVoa5qNE1TRrQt2hezU07BzRo6dbDpC3Z4wE6fcNMBzigYa6GtQSsFhBBo87wCtlTYnj3ETOD4BUOgm75wuD5wuX5iXT8QlgPVEtS8VleAkTbOP98wSgczfhbbOq7o0hXD/oFoRzg/YBgHpJSwLAuClBvgG7UFeKreMagM/Nhy5KjuDBtO8KaDsh1MSLBxRpSqWP/fFOD6nhVa2r0zwxvnDk2g8XsEYSB1gFIWir/NKl4CnWyRVI1gN8vWL/C6g4sj+mGi/R7CxgLUT5uizVa/X86u7g3e7xH1vn8uher6FTGdkZihmU9oXYBUHNtDuQGN5yLb5gXw0aE+PIHjDSqdePOExiSYOBGeCGUTpIFQeSz/wPGqqPgfoDYSrmffoucybtDhwOsFw3zBdLijj3van6Ei4dy2LkuiUkul7GcjnxE8N74LdYPj2xt6wYxyZcK+QH1/QpyuhB2plrCwYJyOzDcUpdpYBM97mu0U5Y7mU7QTPClisRBD2BTGE1Q4op8u2J/uLDmBYWR2iTMWZYrd1FTrfQ9D6957/qku9nd1Z/Dj3qHax60uBG5dvLA6KwILno4PyHGBMAOkn58ujsy142cEur+Ani+zqBD5hfkNZAdHZjgf7+g8q1MUJUQ+MKzmzdpBmgzLkOaP5ZKhy0BZb8B8UqgqlzpON0zHL7i0QsalZNjxvadtobhA6zHGAJszfFaoZFjx4fB2DajmnOG92MwZhnQpKm3aHmeKp0a6hdteNxd0kz9TdLBfeE0BNcX9Avzv5ab6o9F4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"example debug output\"\n        title=\"example debug output\"\n        src=\"/static/5536f32ca293c6e29f763d29acc360a1/fcda8/logs.png\"\n        srcset=\"/static/5536f32ca293c6e29f763d29acc360a1/12f09/logs.png 148w,\n/static/5536f32ca293c6e29f763d29acc360a1/e4a3f/logs.png 295w,\n/static/5536f32ca293c6e29f763d29acc360a1/fcda8/logs.png 590w,\n/static/5536f32ca293c6e29f763d29acc360a1/efc66/logs.png 885w,\n/static/5536f32ca293c6e29f763d29acc360a1/c83ae/logs.png 1180w,\n/static/5536f32ca293c6e29f763d29acc360a1/161ec/logs.png 1840w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h3 id=\"typescript\"><a href=\"#typescript\" aria-label=\"typescript permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Typescript</h3>\n<p>Finally ibridge uses Typescript, this let us express certain things\nsuch as that the Child is generic for <code class=\"language-text\">TModel</code> and <code class=\"language-text\">TContext</code> and so\nyou can have better validations in terms of type safety.</p>\n<p>Additionally I am a big fan of Typescript and the guarantees it provides so\nI basically do nothing without Typescript.</p>\n<h2 id=\"closing\"><a href=\"#closing\" aria-label=\"closing permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Closing</h2>\n<p>Postmate is a great library that was in need for a little bit of love.\nI am open to unifying efforts with the Postmate team so that we can\nhave a single version of this library with all the benefits that <strong>ibridge</strong>\nbrings to the table.</p>\n<p>I will also try to give <strong>ibridge</strong> more support, if you are interested\nin helping me maintain it let me know!</p>\n<hr/>\n<p>Like the content? Consider subscribing, buying me a coffee or even becoming a Patreon below.</p>","fields":{"slug":"/ibridge/","readingTime":{"text":"9 min read"}},"frontmatter":{"title":"Breaking the iframe frontier: ibridge","date":"December 11, 2020","description":"Introducing ibridge, a tiny, typesafe, promise-based library for bidirectional and secure iframe communication.","tags":["ibridge","typescript","javascript","iframe","postMessage","event emitter","Emittery","jsdom"],"seoFooter":null,"author":{"id":"franleplant","bio":"Tech Lead and Software developer with a degree in Engineering. Woodworker, all things Javascript, Rust and Software Architecture.","twitter":"franleplant","github":"https://github.com/franleplant","profilepicture":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACjUlEQVQ4y2P4jwr+/fsHJL9++dLT1RkbFZGWkrxy+fL379/BpZABAxr/79+/QPLyxYsWpiYqSkoaykou9naLFsz/jw2ga/7z5w+QbKitsVSVKorwWFafHuFgLCYscujgAbjRBGzesnHd9vasnwfm/D+1fH1bgaCgwKSJE+BG49QM8diL508nF8Yc6i1cVZ++tafETlf19GEibIZo/vLp/Zn5bfeWd77YNOX8guYj0+v+f/sIkcanGa5i68SqVeXxFxe2nJxVfW7LEpAwqrXYNUMUndm9dk9P/obOgukFYZeO7iFKM9DZf8GhcmDvriw/y3xvgy0tSetn9xw4fPT6tes/f/4kYDMwSJ88eRIREZ7oqDkhw7cxL8nTzc3dw9va2nbPnr3IwcaAFlTv3r3r6OgMj4i0srZ0d7KzMDU2s7T18w/MzMzOyMxdtnwlclJjQNYJJNva2wMCgyOjon39fH18/ULDwvMLivLyi2Jj41NSUpOSU65dvw63nAE5bew9cNDR1T0yJiYkNAQIAgID0zOycnLzw8IjIyIiMzOz4uISdu7cjaIZYu3nz58mtdaWpUYFBwd4eXkFBASGhYUBrQqPjPLy9k5ISEhLS4uKilm/fj0WzauWLT47p+760uakYA9zKytPT4/wcKDfo9zc3aNjolNT0zIyMkNDIzZs2IjQDKFu374NNHtBR8XVlT0N6WGW1jZBQUH+AQGWFibOjg5ABwNRUlJqSEjY9es3EJohaX3OnDlOri7BQItiYuPi4qNjgFRCdkrC6o789MTY0PDI8LBwX1//iooqeNAiNE+cNFFPT9fJ2dHZ1dXF1c3MzMTCwiIiNDgzJc7PP8DX19fb29vOzn7jxo3I8QwAkD8cNPji0p0AAAAASUVORK5CYII=","aspectRatio":1.1363636363636365,"src":"/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png","srcSet":"/static/3d0df698a9c84ca995878f7c2815d974/69585/franleplant-profile.png 200w,\n/static/3d0df698a9c84ca995878f7c2815d974/497c6/franleplant-profile.png 400w,\n/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png 620w","sizes":"(max-width: 620px) 100vw, 620px"}}}}}}},"pageContext":{"slug":"/ibridge/","previous":{"fields":{"slug":"/react-performance/"},"frontmatter":{"title":"React is slow, what now?"}},"next":{"fields":{"slug":"/interview-tanner-linsley/"},"frontmatter":{"title":"Interview with React Query's creator: Tanner Linsley"}}}},"staticQueryHashes":["63159454"]}